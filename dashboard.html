<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Status Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f3f4f6;
            padding: 30px;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #1f2937;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header-stats {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-value.in {
            color: #059669;
        }
        
        .stat-value.out {
            color: #dc2626;
        }
        
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .student-card.in {
            border-color: #10b981;
        }
        
        .student-card.out {
            background: #fee2e2;
            border-color: #dc2626;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .student-name {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .student-id {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 5px;
        }
        
        .status-indicator.in {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .status-indicator.out {
            background: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .status-text {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .status-text.in {
            color: #059669;
        }
        
        .status-text.out {
            color: #dc2626;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc2626;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .reset-button {
            width: 100%;
            padding: 10px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }
        
        .reset-button:hover {
            background: #4338ca;
        }
        
        .reset-button:active {
            transform: scale(0.98);
        }
        
        .last-updated {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 8px;
        }
        
        .no-students {
            text-align: center;
            padding: 60px;
            color: #6b7280;
            font-size: 18px;
        }
        
        /* Schedule Selection Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
        }
        
        .modal-content h2 {
            font-size: 32px;
            color: #1f2937;
            margin-bottom: 15px;
        }
        
        .modal-content p {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .schedule-buttons {
            display: flex;
            gap: 15px;
        }
        
        .schedule-button {
            flex: 1;
            padding: 25px;
            border: none;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-button.red {
            background: #dc2626;
            color: white;
        }
        
        .schedule-button.red:hover {
            background: #b91c1c;
            transform: scale(1.02);
        }
        
        .schedule-button.black {
            background: #1f2937;
            color: white;
        }
        
        .schedule-button.black:hover {
            background: #111827;
            transform: scale(1.02);
        }
        
        .schedule-button:active {
            transform: scale(0.98);
        }
        
        .schedule-selector {
            display: inline-flex;
            gap: 10px;
            background: #f3f4f6;
            padding: 5px;
            border-radius: 10px;
            margin-left: 15px;
        }
        
        .schedule-option {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #6b7280;
        }
        
        .schedule-option.active.red {
            background: #dc2626;
            color: white;
        }
        
        .schedule-option.active.black {
            background: #1f2937;
            color: white;
        }
        
        .start-type-selector {
            display: inline-flex;
            gap: 10px;
            background: #f3f4f6;
            padding: 5px;
            border-radius: 10px;
            margin-left: 15px;
        }
        
        .start-option {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #6b7280;
        }
        
        .start-option.active.regular {
            background: #059669;
            color: white;
        }
        
        .start-option.active.late {
            background: #f59e0b;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Schedule Selection Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal-content">
            <h2>üóìÔ∏è Select Today's Schedule</h2>
            <p>Which schedule are you viewing today?</p>
            <div class="schedule-buttons">
                <button class="schedule-button red" onclick="selectScheduleType('red')">
                    üî¥ Red Day
                </button>
                <button class="schedule-button black" onclick="selectScheduleType('black')">
                    ‚ö´ Black Day
                </button>
            </div>
        </div>
    </div>
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <h1>üìä Classroom Status Dashboard</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="schedule-selector">
                    <button class="schedule-option" id="redOption" onclick="selectScheduleType('red')">üî¥ Red Day</button>
                    <button class="schedule-option" id="blackOption" onclick="selectScheduleType('black')">‚ö´ Black Day</button>
                </div>
                <div class="start-type-selector">
                    <button class="start-option" id="regularOption" onclick="selectStartType('regular')">‚è∞ Regular</button>
                    <button class="start-option" id="lateOption" onclick="selectStartType('late')">üåÖ Late</button>
                </div>
            </div>
        </div>
        <div id="periodInfo" style="color: #6b7280; margin-top: 10px; font-size: 16px;">Loading period info...</div>
        <div class="header-stats">
            <div class="stat">
                <div>
                    <div class="stat-label">In Classroom</div>
                    <div class="stat-value in" id="inCount">0</div>
                </div>
            </div>
            <div class="stat">
                <div>
                    <div class="stat-label">Out of Room</div>
                    <div class="stat-value out" id="outCount">0</div>
                </div>
            </div>
            <div class="stat">
                <div>
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" style="color: #4f46e5;" id="totalCount">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="students-grid" id="studentsGrid">
        <div class="no-students">Loading students...</div>
    </div>

    <script>
        // ====================================
        // FIREBASE CONFIGURATION
        // ====================================
        // Replace with your Firebase config (same as scanner.html)
        const firebaseConfig = {
            	apiKey: "AIzaSyDBD5CIAmEk90zPZ4h1CYkqqj_hmWi0-8Q",
			authDomain: "hallpass-632be.firebaseapp.com",
			databaseURL: "https://hallpass-632be-default-rtdb.firebaseio.com",
			projectId: "hallpass-632be",
			storageBucket: "hallpass-632be.firebasestorage.app",
			messagingSenderId: "300025661409",
			appId: "1:300025661409:web:1fe1931bbbe6d7a0ceb4a0",
			measurementId: "G-JL44XNPHEW"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ====================================
        // DUAL SCHEDULE SYSTEM (Red Day / Black Day)
        // ====================================
        // This should EXACTLY match the schedule in scanner.html
        const schedules = {
		red: {
			regular: [
				// Your normal Red Day periods
					{
					   name: "P1",
						startTime: "08:25",
						endTime: "09:50",
						students: {
							'qr_01': 'Liam Baker',
							'qr_02': 'Flynn Daniels',
							'qr_03': 'Brayden Duke',
							'qr_04': 'Dominic Entriken',
							'qr_05': 'Charles Franklin',
						}
					},
					{
						name: "P2",
						startTime: "10:40",
						endTime: "12:00",
						students: {
							'qr_01': 'Emylene Youvella',
							'qr_02': 'Teagen Andersen',
							'qr_03': 'Samuel Brandon',
							'qr_04': 'Molly Emery',
							'qr_05': 'Leo Feltenstein',
						}
					},
					{
						name: "P3",
						startTime: "12:50",
						endTime: "14:10",
						students: {
							'qr_01': 'Kate Thomas',
							'qr_02': 'Liam Jackson',
							'qr_03': 'Mia White',
							'qr_04': 'Noah Harris',
							'qr_05': 'Olivia Martin',
						}
					},
					{
						name: "P4",
						startTime: "14:15",
						endTime: "15:35",
						students: {
							'qr_01': 'Test Student R01',
							'qr_02': 'Test Student R02',
							'qr_03': 'Test Student R03',
							'qr_04': 'Test Student R04',
							'qr_05': 'Test Student R05',
						}
					},
			],
			late: [
				// Your late start Red Day periods (adjusted times)
				{
					   name: "P1",
						startTime: "09:35",
						endTime: "10:50",
						students: {
							'qr_01': 'Liam Baker',
							'qr_02': 'Flynn Daniels',
							'qr_03': 'Brayden Duke',
							'qr_04': 'Dominic Entriken',
							'qr_05': 'Charles Franklin',
						}
					},
					{
						name: "P2",
						startTime: "11:05",
						endTime: "12:20",
						students: {
							'qr_01': 'Emylene Youvella',
							'qr_02': 'Teagen Andersen',
							'qr_03': 'Samuel Brandon',
							'qr_04': 'Molly Emery',
							'qr_05': 'Leo Feltenstein',
						}
					},
					{
						name: "P3",
						startTime: "13:00",
						endTime: "14:15",
						students: {
							'qr_01': 'Kate Thomas',
							'qr_02': 'Liam Jackson',
							'qr_03': 'Mia White',
							'qr_04': 'Noah Harris',
							'qr_05': 'Olivia Martin',
						}
					},
					{
						name: "P4",
						startTime: "14:20",
						endTime: "15:35",
						students: {
							'qr_01': 'Test Student R01',
							'qr_02': 'Test Student R02',
							'qr_03': 'Test Student R03',
							'qr_04': 'Test Student R04',
							'qr_05': 'Test Student R05',
						}
					},
			]
		},
		black: {
			regular: [
				// Your normal Black Day periods
				{
						name: "P1",
						startTime: "08:25",
						endTime: "09:50",
						students: {
							'qr_01': 'Test Student R01',
							'qr_02': 'Test Student R02',
							'qr_03': 'Test Student R03',
							'qr_04': 'Test Student R04',
							'qr_05': 'Test Student R05',
						}
					},
					{
						name: "P2",
						startTime: "10:40",
						endTime: "12:00",
						students: {
							'qr_01': 'Jackson DuBose',
							'qr_02': 'Logan Lane',
							'qr_03': 'Violet Olsson',
							'qr_04': 'Maren Linden',
							'qr_05': 'Lauren Werner',
						}
					},
					{
						name: "Black 3 - Geometry",
						startTime: "12:50",
						endTime: "14:10",
						students: {
							'qr_01': 'Delilah Harper',
							'qr_02': 'Kendall Opsahl',
							'qr_03': 'Delaney Storck',
							'qr_04': 'Treak Tasker',
							'qr_05': 'Opal Vincent',
						}
					},
					{
						name: "Black 4 - Algebra",
						startTime: "14:15",
						endTime: "15:35",
						students: {
							'qr_01': 'Molly Child',
							'qr_02': 'Kinsley Darling',
							'qr_03': 'Ella Donnelly',
							'qr_04': 'Alese Ewen Fox',
							'qr_05': 'Harper Henry',
						}
					},
			],
			late: [
				// Your late start Black Day periods
				{
						name: "P1",
						startTime: "09:35",
						endTime: "10:50",
						students: {
							'qr_01': 'Test Student R01',
							'qr_02': 'Test Student R02',
							'qr_03': 'Test Student R03',
							'qr_04': 'Test Student R04',
							'qr_05': 'Test Student R05',
						}
					},
					{
						name: "P2",
						startTime: "11:05",
						endTime: "12:20",
						students: {
							'qr_01': 'Jackson DuBose',
							'qr_02': 'Logan Lane',
							'qr_03': 'Violet Olsson',
							'qr_04': 'Maren Linden',
							'qr_05': 'Lauren Werner',
						}
					},
					{
						name: "Black 3 - Geometry",
						startTime: "13:00",
						endTime: "14:15",
						students: {
							'qr_01': 'Delilah Harper',
							'qr_02': 'Kendall Opsahl',
							'qr_03': 'Delaney Storck',
							'qr_04': 'Treak Tasker',
							'qr_05': 'Opal Vincent',
						}
					},
					{
						name: "Black 4 - Algebra",
						startTime: "14:20",
						endTime: "15:35",
						students: {
							'qr_01': 'Molly Child',
							'qr_02': 'Kinsley Darling',
							'qr_03': 'Ella Donnelly',
							'qr_04': 'Alese Ewen Fox',
							'qr_05': 'Harper Henry',
						}
					},
			]
		}
	};

        // Current active schedule
        let activeScheduleType = null; // 'red' or 'black'
        let activeStartType = 'regular'; // 'regular' or 'late'
        let activeSchedule = null; // Combined for backward compatibility
        let classSchedule = [];

        // ====================================
        // SCHEDULE SELECTION FUNCTIONS
        // ====================================
        function selectScheduleType(scheduleType) {
            activeScheduleType = scheduleType;
            updateSchedule();
        }
        
        function selectStartType(startType) {
            activeStartType = startType;
            updateSchedule();
        }
        
        function updateSchedule() {
            if (!activeScheduleType) return;
            
            // Update combined schedule
            activeSchedule = `${activeScheduleType}-${activeStartType}`;
            
            // Check if schedules have nested structure (regular/late)
            if (schedules[activeScheduleType] && schedules[activeScheduleType].regular) {
                // New structure with late start support
                classSchedule = schedules[activeScheduleType][activeStartType] || schedules[activeScheduleType].regular;
            } else {
                // Old structure (backward compatible)
                classSchedule = schedules[activeScheduleType];
            }
            
            // Save to localStorage
            localStorage.setItem('dashboardScheduleType', activeScheduleType);
            localStorage.setItem('dashboardStartType', activeStartType);
            
            // Hide modal
            document.getElementById('scheduleModal').style.display = 'none';
            
            // Update button states
            updateButtonStates();
            
            // Refresh display
            updatePeriodInfo();
        }
        
        function updateButtonStates() {
            // Update schedule type buttons
            document.getElementById('redOption').classList.remove('active', 'red');
            document.getElementById('blackOption').classList.remove('active', 'black');
            
            if (activeScheduleType === 'red') {
                document.getElementById('redOption').classList.add('active', 'red');
            } else if (activeScheduleType === 'black') {
                document.getElementById('blackOption').classList.add('active', 'black');
            }
            
            // Update start type buttons
            document.getElementById('regularOption').classList.remove('active', 'regular');
            document.getElementById('lateOption').classList.remove('active', 'late');
            
            if (activeStartType === 'regular') {
                document.getElementById('regularOption').classList.add('active', 'regular');
            } else if (activeStartType === 'late') {
                document.getElementById('lateOption').classList.add('active', 'late');
            }
        }

        // ====================================
        // HELPER FUNCTION: Get Current Period
        // ====================================
        function getCurrentPeriod() {
            if (!classSchedule || classSchedule.length === 0) return null;
            
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            for (const period of classSchedule) {
                if (currentTime >= period.startTime && currentTime < period.endTime) {
                    return period;
                }
            }
            
            return null;
        }

        // ====================================
        // HELPER FUNCTION: Get All Periods
        // ====================================
        function getAllPeriods() {
            return classSchedule;
        }

        // ====================================
        // TIMER TRACKING
        // ====================================
        const timerIntervals = {};

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer(studentId, timestamp) {
            // Clear existing timer if any
            if (timerIntervals[studentId]) {
                clearInterval(timerIntervals[studentId]);
            }

            const timerEl = document.getElementById(`timer-${studentId}`);
            if (!timerEl) return;

            // Update timer every second
            timerIntervals[studentId] = setInterval(() => {
                const elapsed = Date.now() - timestamp;
                timerEl.textContent = `Out: ${formatTime(elapsed)}`;
            }, 1000);

            // Initial update
            const elapsed = Date.now() - timestamp;
            timerEl.textContent = `Out: ${formatTime(elapsed)}`;
        }

        function stopTimer(studentId) {
            if (timerIntervals[studentId]) {
                clearInterval(timerIntervals[studentId]);
                delete timerIntervals[studentId];
            }
        }

        // ====================================
        // AUTO-RESET AT PERIOD END
        // ====================================
        let lastCheckedPeriod = null;

        async function checkAndAutoReset() {
            if (!activeSchedule || !classSchedule) return;
            
            const currentPeriod = getCurrentPeriod();
            
            // Period just ended (went from having a period to no period)
            if (lastCheckedPeriod && !currentPeriod) {
                console.log(`Period ended: ${lastCheckedPeriod.name}. Auto-resetting students...`);
                await autoResetStudentsFromPeriod(lastCheckedPeriod);
            }
            
            lastCheckedPeriod = currentPeriod;
        }

        async function autoResetStudentsFromPeriod(period) {
            try {
                const snapshot = await database.ref('students').once('value');
                const students = snapshot.val() || {};
                
                const periodSuffix = period.name.replace(/\s+/g, '_');
                
                // Build prefix with start type support
                let schedulePrefix;
                if (schedules[activeScheduleType] && schedules[activeScheduleType].regular) {
                    // New structure with late start
                    schedulePrefix = `${activeScheduleType}_${activeStartType}_`;
                } else {
                    // Old structure (backward compatible)
                    schedulePrefix = `${activeScheduleType}_`;
                }
                
                // Find all students from that period who are still "out"
                const updates = {};
                const logPromises = [];
                
                for (const [studentId, data] of Object.entries(students)) {
                    if (studentId.startsWith(schedulePrefix) && 
                        studentId.endsWith(periodSuffix) && 
                        data.status === 'out') {
                        
                        const outTime = data.outTimestamp || data.timestamp;
                        const inTime = Date.now();
                        const duration = outTime ? (inTime - outTime) : null;
                        
                        // Update student to "in"
                        updates[`students/${studentId}`] = {
                            ...data,
                            status: 'in',
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            outTimestamp: null
                        };
                        
                        // Log the auto-reset event
                        const logRef = database.ref('logs').push();
                        logPromises.push(logRef.set({
                            studentName: data.name,
                            qrCode: data.qrCode,
                            period: data.period,
                            schedule: data.schedule,
                            action: 'auto-reset',
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            date: new Date().toISOString().split('T')[0],
                            outTime: outTime,
                            inTime: inTime,
                            duration: duration
                        }));
                    }
                }
                
                // Perform all updates
                if (Object.keys(updates).length > 0) {
                    await database.ref().update(updates);
                    await Promise.all(logPromises);
                    console.log(`Auto-reset completed for ${Object.keys(updates).length} students`);
                }
                
            } catch (error) {
                console.error('Error auto-resetting students:', error);
            }
        }

        // Check every 30 seconds for period changes
        setInterval(checkAndAutoReset, 30000);
        checkAndAutoReset(); // Initial check

        // ====================================
        // RESET FUNCTION
        // ====================================
        async function resetStudent(studentId) {
            try {
                const snapshot = await database.ref('students/' + studentId).once('value');
                const data = snapshot.val();
                
                if (data && data.status === 'out') {
                    const outTime = data.outTimestamp || data.timestamp;
                    const inTime = Date.now();
                    const duration = outTime ? (inTime - outTime) : null;
                    
                    // Update student status
                    await database.ref('students/' + studentId).update({
                        status: 'in',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        outTimestamp: null
                    });
                    
                    // Log the manual reset
                    const logRef = database.ref('logs').push();
                    await logRef.set({
                        studentName: data.name,
                        qrCode: data.qrCode,
                        period: data.period,
                        schedule: data.schedule,
                        action: 'manual-reset',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        date: new Date().toISOString().split('T')[0],
                        outTime: outTime,
                        inTime: inTime,
                        duration: duration
                    });
                } else {
                    await database.ref('students/' + studentId).update({
                        status: 'in',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        outTimestamp: null
                    });
                }
            } catch (error) {
                console.error('Error resetting student:', error);
                alert('Failed to reset student. Please try again.');
            }
        }

        // ====================================
        // CARD RENDERING
        // ====================================
        function createStudentCard(studentId, data) {
            const card = document.createElement('div');
            card.className = `student-card ${data.status}`;
            card.id = `card-${studentId}`;

            const lastUpdated = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : 'Unknown';
            const parts = studentId.split('_');
			const qrCode = data.qrCode || parts[2] + '_' + parts[3];
            const period = data.period || 'Unknown Period';

            card.innerHTML = `
                <div class="student-header">
                    <div>
                        <div class="student-name">${data.name}</div>
                        <div class="student-id">${qrCode} ‚Ä¢ ${period}</div>
                    </div>
                    <div class="status-indicator ${data.status}"></div>
                </div>
                
                <div class="status-text ${data.status}">
                    ${data.status === 'in' ? '‚úì In Classroom' : '‚ö† Out of Room'}
                </div>
                
                ${data.status === 'out' ? `<div class="timer" id="timer-${studentId}">Out: 00:00</div>` : ''}
                
                <button class="reset-button" onclick="resetStudent('${studentId}')">
                    Reset to "In"
                </button>
                
                <div class="last-updated">Last updated: ${lastUpdated}</div>
            `;

            return card;
        }

        function updateStudentCard(studentId, data) {
            const existingCard = document.getElementById(`card-${studentId}`);
            if (existingCard) {
                existingCard.remove();
            }

            const grid = document.getElementById('studentsGrid');
            const newCard = createStudentCard(studentId, data);
            grid.appendChild(newCard);

            // Start timer if student is out
            if (data.status === 'out' && data.timestamp) {
                startTimer(studentId, data.timestamp);
            } else {
                stopTimer(studentId);
            }
        }

        // ====================================
        // STATISTICS UPDATE
        // ====================================
        function updateStats(students) {
            let inCount = 0;
            let outCount = 0;

            Object.values(students).forEach(student => {
                if (student.status === 'in') {
                    inCount++;
                } else {
                    outCount++;
                }
            });

            document.getElementById('inCount').textContent = inCount;
            document.getElementById('outCount').textContent = outCount;
            document.getElementById('totalCount').textContent = inCount + outCount;
        }

        // ====================================
        // PERIOD INFO DISPLAY
        // ====================================
        function updatePeriodInfo() {
            const periodInfoEl = document.getElementById('periodInfo');
            const currentPeriod = getCurrentPeriod();
            
            if (currentPeriod) {
                periodInfoEl.innerHTML = `üìö <strong>${currentPeriod.name}</strong> (${currentPeriod.startTime} - ${currentPeriod.endTime})`;
                periodInfoEl.style.color = '#059669';
            } else {
                periodInfoEl.innerHTML = `‚è∏Ô∏è No active class period`;
                periodInfoEl.style.color = '#6b7280';
            }
        }

        // Update period info every minute
        setInterval(updatePeriodInfo, 60000);
        updatePeriodInfo();


    // ====================================
        // FIREBASE LISTENERS
        // ====================================
        const studentsRef = database.ref('students');

        studentsRef.on('value', (snapshot) => {
            if (!activeScheduleType) return; 
            
            const firebaseData = snapshot.val() || {};
            const grid = document.getElementById('studentsGrid');
            const currentPeriod = getCurrentPeriod();

            if (!currentPeriod) {
                const dayLabel = activeScheduleType === 'red' ? 'üî¥ Red Day' : '‚ö´ Black Day';
                const startLabel = activeStartType === 'late' ? 'üåÖ Late Start' : '‚è∞ Regular';
                grid.innerHTML = `<div class="no-students">No active class period for ${dayLabel} ${startLabel}</div>`;
                updateStats({});
                return;
            }

            const expectedStudents = currentPeriod.students; 
            const periodSuffix = currentPeriod.name.replace(/\s+/g, '_');
            
            // Build prefix with start type support
          const schedulePrefix = `${activeScheduleType}_${activeStartType}_`;

            let displayStudents = {};
            let inCount = 0;
            let outCount = 0;

            Object.keys(expectedStudents).forEach(qrCode => {
                const studentId = `${schedulePrefix}${qrCode}_${periodSuffix}`;
                
                const record = firebaseData[studentId] || {
                    name: expectedStudents[qrCode],
                    status: 'in',
                    qrCode: qrCode,
                    period: currentPeriod.name,
                    schedule: activeSchedule,
                    timestamp: null
                };

                displayStudents[studentId] = record;
                if (record.status === 'in') inCount++;
                else outCount++;
            });

            document.getElementById('inCount').textContent = inCount;
            document.getElementById('outCount').textContent = outCount;
            document.getElementById('totalCount').textContent = inCount + outCount;

            grid.innerHTML = '';
            Object.keys(displayStudents).forEach(studentId => {
                const card = createStudentCard(studentId, displayStudents[studentId]);
                grid.appendChild(card);
                
                if (displayStudents[studentId].status === 'out' && displayStudents[studentId].timestamp) {
                    startTimer(studentId, displayStudents[studentId].timestamp);
                }
            });
        });

        // Check if schedule was previously selected
        window.addEventListener('load', () => {
            const savedScheduleType = localStorage.getItem('dashboardScheduleType');
            const savedStartType = localStorage.getItem('dashboardStartType') || 'regular';
            
            if (savedScheduleType && (savedScheduleType === 'red' || savedScheduleType === 'black')) {
                activeScheduleType = savedScheduleType;
                activeStartType = savedStartType;
                updateSchedule();
            } else {
                document.getElementById('scheduleModal').style.display = 'flex';
            }
        });

        window.resetStudent = resetStudent;
        window.selectScheduleType = selectScheduleType;
        window.selectStartType = selectStartType;
    </script>
</body>
</html>
